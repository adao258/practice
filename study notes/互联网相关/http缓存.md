<!--
 * @Author: your name
 * @Date: 2022-01-20 10:14:59
 * @LastEditTime: 2022-03-23 09:36:00
 * @LastEditors: Please set LastEditors
 * @Description: 打开koroFileHeader查看配置 进行设置: https://github.com/OBKoro1/koro1FileHeader/wiki/%E9%85%8D%E7%BD%AE
 * @FilePath: \Front-end development learning\document\notes\study notes\互联网相关\http缓存.md
-->

# 缓存

- 浏览器缓存
  浏览器每次发起请求，都会先在浏览器缓存中查找该请求的结果以及缓存标识
  浏览器每次拿到返回的请求结果都会将该结果和缓存标识存入浏览器缓存中
- 强制缓存
  向浏览器缓存查找请求结果，并根据该结果的缓存规则来决定是否使用该缓存结果的过程。
  不存在缓存结果和缓存标识，强制缓存失效，直接向服务器发起请求
  存在缓存结果和缓存标识，但该结果已经失效，强制缓存失效，则使用协商缓存
  存在该缓存结果和缓存标识，且该结果尚未生效，强制缓存生效，直接返回结果

  - 在 HTTP/1.1 中，Cache-Control 是最重要的规则，主要用于控制网页缓存，主要取值为：
    public 所有内容都将被缓存，客户端和代理服务器都将被缓存
    private 所有内容只有客户端可以缓存，为默认值
    no-cache 客户端缓存内容，但是是否使用缓存则需经过协商缓存来验证决定
    no-store 所有内容都不会被缓存，即不使用强制缓存，也不使用协商缓存
    max-age=xxx(xxx is numeric)

- 缓存存放的位置
  from memory cache 使用内存中的缓存
  快速读取:内存缓存会将编译解析后的文件，直接存入该进程的内存中占据该进程一定的内存资源，以方便下次运行时段快速读取
  时效性:一旦进程关闭，内存会清空
  from disk cache 使用硬盘中的缓存:直接将缓存写入硬盘文件中，读取缓存需要对该缓存存放的硬盘文件进行 i/o 操作，然后重新解析该缓存内容，读取复杂，速度比内存缓存慢
- 在不让浏览器发送请求但缓存又没有到期时发现 bug 该怎么处理(想更新 foo.css，又想设置尽量长的缓存时间，又想要能随时更新)
  解决办法:给资源加版本号，比如通过 query 加版本号，每次上线加版本号就可以，但是如果只想更新 foo.css 但 bar.css 缓存也失效了(就是得重新发送请求)，又造成了带宽浪费，解决: 将文件内容与版本号绑定，当文件内容发生改变时才该变版本号(URL)这样就实现每个文件精确的缓存控制
- 协商缓存
  协商缓存就是强制缓存失效后，浏览器携带缓存标识向服务器发起请求
  向服务器发送请求，服务器会根据这个请求的 request header 的一些参数来判断是否命中协商缓存，如果命中，则返回 304 状态码并带上新的 request header，通知浏览器从缓存缓存中读取
  协商缓存生效--返回 304 状态码
  协商缓存失效--返回 200 状态码，相当于发起一次请求

  - 标识
    LastModified/If-Modified-Since(最后修改/判断最后修改时间是否过期，没有返回 200，过期返回 304)
    LastModified：是服务器响应请求时，返回该资源文件在服务器最后被修改的时间
    If-Modified-Since：是客户端再次发起该请求时，携带上次请求返回 LastModified 的值，通过此字段值告诉服务器该资源上次请求返回的最后被修改时间，服务器收到该请求发现请求头含有 If-Modified-Since 字段，则会根据 If-Modified-Since 的字段值与该资源在服务器的最后被修改时间做对比，如果服务器的最后被修改时间大于 If-Modified-Since 字段，则重新返回资源状态码为 200，否则返回 304，继续使用缓存

    Etag/If-None-Match
    Etag 是服务器响应请求时，返回当前资源文件的唯一一个标识(由服务器生成)
    If-None-Match 是客户端再次发起请求时，携带上次请求返回的唯一标识 Etag，通过此字段告诉服务器该资源上次请求返回的唯一一个标识值，服务器收到请求后，发现该请求头中含有 If-None-Match，则会根据 If-None-Match 的字段值与 Etag 做对比，一致则返回 304，使用缓存文件，不一致则重新返回资源文件，状态码为 200
    浏览器请求资源(foo.css,eTag=10001) --- 判断是否改变 --- 改变(状态码 200,新的 eTag=10002) --- 无改变返回 304

- 强制缓存是根据过期时间来使用的 ，协商缓存是根据文件有没有修改来使用的，如果过期了就需要使用协商缓存来确定文件有没有修改，如果修改了就需要服务器返回修改后的资源，如果没有修改就还是可以使用缓存的资源
