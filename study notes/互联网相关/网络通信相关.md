# web 端即时通讯技术

- 浏览器客户端本身不具备直接通过系统调用和另外一个客户端通信，桌面应用通过 socket 和远程主机上另外一个进程建立 tcp 连接，从而达到全双工的即时通信，浏览器从诞生至今一直是客户端向服务器发送请求，服务器返回响应，因此要实现两个客户端之间的通信一定得
  服务器进行转发，
- 传统通信方式实现 IM 应用需要解决的问题
  双全工通信:达到浏览器拉取服务器数据，服务器推送数据
  低延迟:浏览器 a 发送给 b 的信息要经过服务器转发给 b，实际上就是要求浏览器快速请求数据，服务器能够快速推送数据到浏览器
  支持跨域:通常客户端浏览器和服务器都是处于网络的不同位置，浏览器本身不允许通过脚本直接访问不同域名下的服务器，即使 IP 地址相同域名不同也不行，域名相同端口不同也不行，这方面主要是为了安全考虑。
- 全双工低延迟的解决方法

1. 客户端浏览器轮询服务器:
   这是最简单的一种解决方案，其原理是在客户端通过 Ajax 的方式的方式每隔一小段时间就发送一个请求到服务器，服务器返回最新数据，然后客户端根据获得的数据来更新界面，这样就间接实现了即时通信。优点是简单，缺点是对服务器压力较大，浪费带宽流量（通常情况下数据都是没有发生改变的）。
2. 长轮询（long-polling）
   由于每次都要发送一个请求，服务端不管数据是否发生变化都发送数据，请求完成后连接关闭。这中间经过的很多通信是不必要的，于是又出现了长轮询（long-polling）方式。这种方式是客户端发送一个请求到服务器，服务器查看客户端请求的数据是否发生了变化（是否有最新数据），如果发生变化则立即响应返回，否则保持这个连接并定期检查最新数据，直到发生了数据更新或连接超时。同时客户端连接一旦断开，则再次发出请求，这样在相同时间内大大减少了客户端请求服务器的次数。
3. 基于 http-stream 通信
   基于 XHR 对象的 streaming 方式。
   基于 iframe 的数据流。
   基于 htmlFile 的数据流通信。
   上面的 long-polling 技术为了保持客户端与服务端的长连接采取的是服务端阻塞.还存在一种基于 http-stream 流的通信方式。其原理是让客户端在一次请求中保持和服务端连接不断开，然后服务端源源不断传送数据给客户端，就好比数据流一样，并不是一次性将数据全部发给客户端。它与 polling 方式的区别在于整个通信过程客户端只发送一次请求，然后服务端保持与客户端的长连接，并利用这个连接在回送数据给客户端。
4. SSE（服务器推送事件（Server-sent Events）
   为了解决浏览器只能够单向传输数据到服务端，HTML5 提供了一种新的技术叫做服务器推送事件 SSE。它能够实现客户端请求服务端，然后服务端利用与客户端建立的这条通信连接 push 数据给客户端，客户端接收数据并处理的目的。从独立的角度看，SSE 技术提供的是从服务器单向推送数据给浏览器的功能，但是配合浏览器主动请求，实际上就实现了客户端和服务器的双向通信。它的原理是在客户端构造一个 eventSource 对象，该对象具有 readySate 属性，

- 跨域解决方法

1. 基于 XHR 的 CORS（跨域资源共享）
   CORS（跨域资源共享）是一种允许浏览器脚本向出于不同域名下服务器发送请求的技术，它是在原生 XHR 请求的基础上，XHR 调用 open 方法时，地址指向一个跨域的地址，在服务端通过设置'Access-Control-Allow-Origin':'_'响应头部告诉浏览器，发送的数据是一个来自于跨域的并且服务器允许响应的数据，浏览器接收到这个 header 之后就会绕过平常的跨域限制，从而和平时的 XHR 通信没有区别。该方法的主要好处是在于客户端代码不用修改，服务端只需要添加'Access-Control-Allow-Origin':'_'头部即可。适用于 ff,safari,opera,chrome 等非 IE 浏览器。跨域的 XHR 相比非跨域的 XHR 有一些限制，这是为了安全所需要的，主要有以下限制：
   客户端不能使用 setRequestHeader 设置自定义头部；
   不能发送和接收 cookie；
   调用 getAllResponseHeaders()方法总会返回空字符串。
2. 基于 XDR 的 CORS
   对于 IE8-10，它是不支持使用原生的 XHR 对象请求跨域服务器的，它自己实现了一个 XDomainRequest 对象，类似于 XHR 对象，能够发送跨域请求，它主要有以下限制：
   cookie 不会随请求发送，也不会随响应返回；
   只能设置请求头部信息中的 Content-Type 字段；
   不能访问响应头部信息；
   只支持 Get 和 Post 请求；
   只支持 IE8-IE10。
3. 基于 JSONP 的跨域
   这种方式不需要在服务端添加 Access-Control-Allow-Origin 头信息，其原理是利用 HTML 页面上 script 标签对跨域没有限制的特点，让它的 src 属性指向服务端请求的地址，其实是通过 script 标签发送了一个 http 请求，服务器接收到这个请求之后，返回的数据是自己的数据加上对客户端 JS 函数的调用，其原理类似于我们上面所说的 iframe 流的方式，客户端浏览器接收到返回的脚本调用会解析执行，从而达到更新界面的目的

- Comet
  以即时通信为代表的 web 应用程序对数据的 Low Latency 要求，传统的基于轮询的方式已经无法满足，而且也会带来不好的用户体验。于是一种基于 http 长连接的“服务器推”技术便被 hack 出来。这种技术被命名为 Comet，典型的 Ajax 通信方式也是 http 协议的经典使用方式，要想取得数据，必须首先发送请求。在 Low Latency 要求比较高的 web 应用中，只能增加服务器请求的频率。Comet 则不同，客户端与服务器端保持一个长连接，只有客户端需要的数据更新时，服务器才主动将数据推送给客户端。

- WebSocket
  websocket 的通信原理和机制
