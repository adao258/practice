# 模板编译

- 如何让虚拟 dom 拿到 vnode

1. 将模板编译成渲染函数

- 将模板解析成 AST 抽象模板树
- 使用 AST 生成渲染函数(由于静态模板不需要总是重新渲染，所以在生成 AST 之后，生成渲染函数之前需要遍历 AST，给所有静态模板做一个标记，这样在更新节点时，如果发现这个节点有标记，就不会重新渲染)
- 模板编译大体上可分为三个部分:
  - 将模板解析为 AST -> 遍历 AST 标记静态节点 -> 使用 AST 生成渲染函数
  - 解析器 -> 优化器 -> 代码生成器
- 解析器:将模板解析为 AST
  - 过滤解析器
  - 文本解析器
  - HTML 解析器
- 优化器:遍历 AST 检测出所有静态子树
- 代码生成器: 将 AST 转换成渲染函数中的内容

2. 解析器

- 他只是用 js 中的对象来描述一个节点，一个对象表示一个节点，对象中的属性用来保存节点所需的各种数据

3. 优化器

- 在 AST 中找出静态子树并打上标记
- 标记静态子树有两点好处
  - 每次重新渲染时不需要为静态子树创建新的节点
  - 在虚拟 dom 中打补丁(patching)的过程可以跳过(两个节点都是静态子树，就不需要进行对比与更新 dom 的操作)
- 优化器的内部实现主要分为两个部分
  - 在 AST 中查找出全部的静态节点并打上标记
  - 在 AST 中找出所有的静态根节点并打是上标记(一个节点下的所有子节点都是静态节点，并且他的父级是动态节点，那么他就是静态根节点)
-
-
-
-
